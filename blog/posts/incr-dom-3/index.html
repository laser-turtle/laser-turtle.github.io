<!doctype html>

<html lang="en">

<head>
  <title>A Blog</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="A blog description" />
  <meta name="author" content="" />
  <meta name="generator" content="Hugo 0.64.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="/blog/css/styles.css" />
</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="/blog/">A Blog</a>
            </h1>

      <ul id="social-media">
             
      </ul>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="/blog/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/blog/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="/blog/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Getting Started With Incr_dom - Part 3</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2019-09-01T14:04:57-07:00">Sep 1, 2019</time>
        </li>
        
        

        

        <li>3 min read</li>
    </ul>
</aside>
    

    <p>In this installment of the tutorial we&rsquo;ll get the basics of the Tetris game working. We&rsquo;ll create a 10x24 space board and use the standard pieces. There will be a preview box, score, and line clear animation.</p>
<h4 id="adding-a-board">Adding A Board</h4>
<p>So we don&rsquo;t clutter the main <code>tetris.ml</code>, let&rsquo;s create a new file <code>lib/board.ml</code> to store the board model. This will encapsulate both the shapes and the board operations. To start create a type for the cells:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ocaml" data-lang="ocaml"><span style="color:#66d9ef">module</span> <span style="color:#a6e22e">Cell</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>
  <span style="color:#66d9ef">type</span> t <span style="color:#f92672">=</span> <span style="color:#a6e22e">S</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Z</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">T</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">L</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">I</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">O</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">J</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Empty</span>
  <span style="color:#f92672">[</span><span style="color:#f92672">@@</span>deriving sexp<span style="color:#f92672">,</span> compare<span style="color:#f92672">]</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Fairly straight forward, we put it in a module to keep the helper functions namespaced. Now we need to create our board representation. We&rsquo;ll use an immutable map because OCaml arrays are mutable. We&rsquo;d have to copy the array each time we made and update, but the map will automatically share as much as possible.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ocaml" data-lang="ocaml"><span style="color:#66d9ef">module</span> <span style="color:#a6e22e">IntPair</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>
  <span style="color:#66d9ef">module</span> <span style="color:#a6e22e">T</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>
    <span style="color:#66d9ef">type</span> t <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">int</span>
    <span style="color:#f92672">[</span><span style="color:#f92672">@@</span>deriving compare<span style="color:#f92672">,</span> sexp<span style="color:#f92672">]</span>
  <span style="color:#66d9ef">end</span>

  <span style="color:#66d9ef">include</span> <span style="color:#a6e22e">T</span> 
  <span style="color:#66d9ef">include</span> Comparable.<span style="color:#a6e22e">Make</span><span style="color:#f92672">(</span><span style="color:#a6e22e">T</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">type</span> t <span style="color:#f92672">=</span> Cell.t IntPair.Map.t
<span style="color:#f92672">[</span><span style="color:#f92672">@@</span>deriving sexp<span style="color:#f92672">,</span> compare<span style="color:#f92672">]</span>
</code></pre></div><p>We wrap up the <code>int * int</code> type in a module so we can derive the <code>Map</code> module without having to deal with all the type variables. Now that we have our board, we need an initial empty board. Let&rsquo;s create a variable to store that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ocaml" data-lang="ocaml"><span style="color:#66d9ef">let</span> empty_board <span style="color:#f92672">=</span>
  <span style="color:#66d9ef">let</span> board <span style="color:#f92672">=</span> ref IntPair.Map.empty <span style="color:#66d9ef">in</span>
  <span style="color:#66d9ef">for</span> x<span style="color:#f92672">=</span>0 <span style="color:#66d9ef">to</span> 9 <span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">for</span> y<span style="color:#f92672">=</span>0 <span style="color:#66d9ef">to</span> 23 <span style="color:#66d9ef">do</span>
      board <span style="color:#f92672">:=</span> IntPair.Map.set <span style="color:#f92672">!</span>board <span style="color:#f92672">~</span>key<span style="color:#f92672">:</span><span style="color:#f92672">(</span>x<span style="color:#f92672">,</span> y<span style="color:#f92672">)</span> <span style="color:#f92672">~</span>data<span style="color:#f92672">:</span>Cell.<span style="color:#a6e22e">Empty</span>
    <span style="color:#66d9ef">done</span>
  <span style="color:#66d9ef">done</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">!</span>board
<span style="color:#f92672">;;</span>

</code></pre></div><p>Pretty simple, take an empty map and fill it with an entry for every coordinate in our board mapping to the empty cell. Let&rsquo;s now add this to the overall model and try to show it on the <code>New Game</code> screen. In <code>lib/tetris.ml</code> a couple updates are needed. First the <code>Model.t</code> type needs to have a <code>board</code> field. The <code>Model.init</code> function needs to set the board field to <code>Board.empty_board</code>. Lastly, when we <code>ChangePage</code> to the <code>NewGame</code> page we need to reset the board state.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ocaml" data-lang="ocaml"><span style="color:#66d9ef">module</span> <span style="color:#a6e22e">Model</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">struct</span>
  <span style="color:#75715e">(*</span><span style="color:#75715e"> ... </span><span style="color:#75715e">*)</span>
  <span style="color:#66d9ef">type</span> t <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
    current_page <span style="color:#f92672">:</span> page<span style="color:#f92672">;</span>
    board <span style="color:#f92672">:</span> Board.t<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#f92672">[</span><span style="color:#f92672">@@</span>deriving sexp<span style="color:#f92672">,</span> compare<span style="color:#f92672">]</span>

  <span style="color:#66d9ef">let</span> init <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> 
    current_page <span style="color:#f92672">=</span> <span style="color:#a6e22e">MainMenu</span><span style="color:#f92672">;</span>
    board <span style="color:#f92672">=</span> Board.empty_board<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">(*</span><span style="color:#75715e"> ... </span><span style="color:#75715e">*)</span>
<span style="color:#66d9ef">end</span>
<span style="color:#75715e">(*</span><span style="color:#75715e"> ... </span><span style="color:#75715e">*)</span>
<span style="color:#66d9ef">let</span> apply_action <span style="color:#f92672">(</span>model <span style="color:#f92672">:</span> Model.t<span style="color:#f92672">)</span> <span style="color:#75715e">(*</span><span style="color:#75715e"> ... </span><span style="color:#75715e">*)</span> <span style="color:#f92672">=</span>
  <span style="color:#66d9ef">match</span> action <span style="color:#66d9ef">with</span>
  <span style="color:#f92672">|</span> <span style="color:#a6e22e">ChangePage</span> <span style="color:#a6e22e">NewGame</span> <span style="color:#f92672">-&gt;</span>
    Model.<span style="color:#f92672">{</span> board <span style="color:#f92672">=</span> Board.empty_board<span style="color:#f92672">;</span> current_page <span style="color:#f92672">=</span> <span style="color:#a6e22e">NewGame</span> <span style="color:#f92672">}</span>

  <span style="color:#f92672">|</span> <span style="color:#a6e22e">ChangePage</span> new_page <span style="color:#f92672">-&gt;</span>
    Model.<span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> current_page <span style="color:#f92672">=</span> new_page <span style="color:#f92672">}</span>
<span style="color:#f92672">;;</span>
</code></pre></div><p>But, the board still needs to be drawn on screen. To do that we need to update the <code>new_game_page</code> function to take a board and render the appropriate HTML.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="/blog/posts/incr-dom-2/"><i class="fa fa-chevron-circle-left"></i> Getting Started With Incr_dom - Part 2</a>
        </li>
        
        
        <li>
            <a href="/blog/posts/erogodox-ez-trackball/">ErogoDox EZ Trackball Mod <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6>Copyright © 2019 - Laser Turtle | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="/blog/blogindex.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="/blog/js/scripts.js"></script>
</body>

</html>